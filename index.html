<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Pendientes de Armonización Legislativa</title>

<link rel="icon" href="favicon.png" type="image/png">

<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">

<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<style>
body {
    font-family: Arial, sans-serif;
    margin: 40px;
}

h2 {
    margin-bottom: 5px;
}

#ultima-actualizacion {
    margin-bottom: 20px;
    font-weight: bold;
}
</style>
</head>

<body>

<h2>Pendientes de Armonización Legislativa</h2>
<div id="ultima-actualizacion"></div>

<table id="tabla" class="display" style="width:100%">
<thead>
<tr>
<th>No</th>
<th>ORDENAMIENTO</th>
<th>MATERIA REFORMA</th>
<th>PUBLICACIÓN DOF</th>
<th>PLAZO PARA ARMONIZAR</th>
<th>FECHA LÍMITE</th>
<th>VENCIMIENTO</th>
<th>HECHO</th>
<th>ENLACE</th>
</tr>
</thead>
</table>

<script>

// Cálculo correcto sin error de zona horaria
function calcularVencimiento(fechaLimiteStr) {

    const partes = fechaLimiteStr.split("/");

    const fechaLimiteUTC = Date.UTC(
        parseInt(partes[2]),
        parseInt(partes[1]) - 1,
        parseInt(partes[0])
    );

    const hoy = new Date();
    const hoyUTC = Date.UTC(
        hoy.getFullYear(),
        hoy.getMonth(),
        hoy.getDate()
    );

    const diferencia = Math.round((fechaLimiteUTC - hoyUTC) / (1000 * 60 * 60 * 24));

    if (diferencia < 0) {
        return "VENCIDO";
    } else if (diferencia === 0) {
        return "VENCE HOY";
    } else {
        return "FALTAN " + diferencia + " DÍAS";
    }
}

$(document).ready(function() {

    $.ajax({
        url: "datos.csv",
        dataType: "text",
        success: function(data) {

            const lineas = data.trim().split("\n");
            const encabezados = lineas[0].split(",");
            const datos = [];

            for (let i = 1; i < lineas.length; i++) {

                if (!lineas[i].trim()) continue;

                const fila = lineas[i].match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                if (!fila) continue;

                const objeto = {};

                encabezados.forEach((enc, index) => {
                    objeto[enc.trim()] = fila[index]
                        ? fila[index].replace(/"/g, "").trim()
                        : "";
                });

                datos.push(objeto);
            }

            $('#tabla').DataTable({
                data: datos,
                columns: [
                    { data: "No" },
                    { data: "ORDENAMIENTO" },
                    { data: "MATERIA REFORMA" },
                    { data: "PUBLICACIÓN DOF" },
                    { data: "PLAZO PARA ARMONIZAR" },
                    { data: "FECHA LÍMITE" },
                    {
                        data: "FECHA LÍMITE",
                        render: function(data) {
                            return calcularVencimiento(data);
                        }
                    },
                    { data: "HECHO" },
                    {
                        data: "ENLACE",
                        render: function(data) {
                            return '<a href="' + data + '" target="_blank">Ver decreto</a>';
                        }
                    }
                ],
                language: {
                    url: "https://cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json"
                }
            });

        }
    });

    // Última actualización automática
    const hoy = new Date();
    const fechaFormateada = hoy.toLocaleDateString('es-MX', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    document.getElementById("ultima-actualizacion").innerText =
        "Última actualización: " + fechaFormateada;

});

</script>

</body>
</html>
